<?php
// conexion segura
include("conexion.php");
ini_set('display_errors', 1);
error_reporting(E_ALL);

// variable de resultado
$mensaje = "";

// procesar POST con seguridad
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $id = isset($_POST['id']) ? intval($_POST['id']) : 0;
  $nombre = isset($_POST['nombre']) ? $conexion->real_escape_string($_POST['nombre']) : "";
  $contraseña = isset($_POST['contraseña']) ? $conexion->real_escape_string($_POST['contraseña']) : "";

  if (isset($_POST['crear']) && $nombre && $contraseña) {
    $hash = password_hash($contraseña, PASSWORD_DEFAULT);
    $sql = "INSERT INTO usuarios (nombre, contraseña) VALUES ('$nombre', '$hash')";
    $mensaje = $conexion->query($sql) ? "✅ Usuario creado correctamente" : "❌ Error: " . $conexion->error;
  }

  if (isset($_POST['actualizar']) && $id > 0) {
    $hash = password_hash($contraseña, PASSWORD_DEFAULT);
    $sql = "UPDATE usuarios SET nombre='$nombre', contraseña='$hash' WHERE id=$id";
    $mensaje = $conexion->query($sql) ? "✏️ Usuario actualizado" : "❌ Error: " . $conexion->error;
  }

  if (isset($_POST['eliminar']) && $id > 0) {
    $sql = "DELETE FROM usuarios WHERE id=$id";
    $mensaje = $conexion->query($sql) ? "🗑️ Usuario eliminado" : "❌ Error: " . $conexion->error;
  }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario limpio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="estilos.css">
</head>
<body>

  <h2>Gestión de usuarios</h2>

  <?php if ($mensaje): ?>
    <div class="mensaje"><?= $mensaje ?></div>
  <?php endif; ?>

  <form method="POST">
    <label>ID:</label><input type="number" name="id"><br>
    <label>Nombre:</label><input type="text" name="nombre" required><br>
    <label>Contraseña:</label><input type="text" name="contraseña" required><br>
    <button name="crear">Crear</button>
    <button name="actualizar">Actualizar</button>
    <button name="eliminar">Eliminar</button>
  </form>

  <hr>
  <h3>📋 Usuarios registrados:</h3>
  <?php
  $result = $conexion->query("SELECT id, nombre FROM usuarios ORDER BY id ASC");
  if ($result && $result->num_rows > 0) {
    while ($row = $result->fetch_assoc()) {
      echo "🔹 ID: {$row['id']} - Nombre: {$row['nombre']}<br>";
    }
  } else {
    echo "📭 No hay usuarios aún.";
  }
  ?>

</body>
</html>
